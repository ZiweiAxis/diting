#!/bin/bash

# Diting 测试脚本
# 用于测试代理服务器和审批流程

echo "╔════════════════════════════════════════════════════════╗"
echo "║         Diting 测试脚本                                ║"
echo "╚════════════════════════════════════════════════════════╝"
echo ""

PROXY="http://127.0.0.1:8081"

# 测试 1: 低风险请求（GET，应该自动放行）
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "测试 1: 低风险 GET 请求（应该自动放行）"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
curl -x "$PROXY" -s -o /dev/null -w "状态码: %{http_code}\n" https://httpbin.org/get
echo ""

# 测试 2: 中风险请求（POST 到安全域名）
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "测试 2: 中风险 POST 请求（需要审批）"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "请在飞书中回复 '批准' 或 '拒绝'"
curl -x "$PROXY" -X POST -s -o /dev/null -w "状态码: %{http_code}\n" https://httpbin.org/post
echo ""

# 测试 3: 高风险请求（DELETE 到危险路径）
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "测试 3: 高风险 DELETE 请求（需要审批）"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "请在飞书中回复 '批准' 或 '拒绝'"
curl -x "$PROXY" -X DELETE -s -o /dev/null -w "状态码: %{http_code}\n" https://httpbin.org/delete
echo ""

# 测试 4: HTTPS CONNECT
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "测试 4: HTTPS CONNECT 隧道"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
curl -x "$PROXY" -s -o /dev/null -w "状态码: %{http_code}\n" https://www.google.com
echo ""

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "测试完成！请检查："
echo "1. Diting 终端输出"
echo "2. 飞书群聊中的审批消息"
echo "3. logs/audit.jsonl 审计日志"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
