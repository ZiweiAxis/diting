# Sentinel-AI DNS 劫持架构 - 交付说明

## 📦 新增文件

| 文件 | 说明 | 大小 |
|------|------|------|
| `ARCHITECTURE_DNS_HIJACK.md` | DNS 劫持架构设计文档 | 21 KB |
| `dnshijack.go` | DNS 劫持器实现 (Go) | 7.2 KB |
| `wafgateway.go` | WAF 网关实现 (Go) | 11 KB |

---

## 🎯 核心原理

### DNS 劫持流程

```
┌──────────┐     DNS      ┌──────────────┐
│  Agent   │ ────────► │ DNS 劫持器    │
│          │             │ (返回假 IP)   │
└─────┬────┘             └──────┬───────┘
      │                          │
      │ HTTP                    │ IP: 10.0.0.1 (假的)
      │                         │ (指向 Sentinel-AI)
      ▼                         │
┌──────────────┐                │
│ Sentinel-AI  │ ◄───────────────┘
│   WAF 网关    │
└──────┬───────┘
       │
       │ 代理转发 (真实 IP)
       ▼
┌─────────────────────────────────┐
│  外部服务 (api.example.com)      │
└─────────────────────────────────┘
```

### 关键点

1. **Agent 以为直接访问** - Agent 不知道流量被劫持
2. **无法绕过** - DNS 解析被劫持，Agent 不知道真实 IP
3. **全协议支持** - HTTP/HTTPS/gRPC/TCP 都可拦截
4. **透明代理** - Agent 无需任何修改

---

## 🚀 快速启动

### 1. 启动 DNS 劫持器

```bash
cd E:\workspace\sentinel-ai
go run dnshijack.go
```

输出:
```
╔════════════════════════════════════════════════════════╗
║         Sentinel-AI DNS 劫持器 v1.0                  ║
║    将所有 Agent DNS 查询劫持到 WAF 网关               ║
╚════════════════════════════════════════════════════════╝

配置:
  监听地址: :53
  网关 IP:  10.0.0.1
  上游 DNS: 8.8.8.8:53
  劫持域名 (3):
    - api.example.com
    - db.example.com
    - auth.example.com

✓ DNS 劫持器启动成功
```

### 2. 启动 WAF 网关

```bash
# 另一个终端
cd E:\workspace\sentinel-ai
go run wafgateway.go
```

输出:
```
╔════════════════════════════════════════════════════════╗
║         Sentinel-AI WAF 网关 v1.0                    ║
║    接收 DNS 劫持流量，进行深度检测和治理              ║
╚════════════════════════════════════════════════════════╝

配置:
  监听地址: 10.0.0.1:8080
  Ollama: http://localhost:11434 (qwen2.5:7b)
  DNS 映射 (3):
    api.example.com → 1.2.3.4:80
    db.example.com → 5.6.7.8:3306
    auth.example.com → 9.10.11.12:443

✓ WAF 网关启动成功
```

### 3. 配置 Agent DNS

在 Agent 容器内执行:

```bash
# 修改 /etc/resolv.conf
echo "nameserver 10.0.0.1" > /etc/resolv.conf

# 或使用 DNS ConfigMap (K8s)
# dnsConfig:
#   nameservers:
#     - 10.0.0.1
```

### 4. 测试

```bash
# 在 Agent 容器内测试
curl http://api.example.com/api/users
```

WAF 网关输出:
```
[15:30:45] 收到请求
  方法: GET
  Host: api.example.com
  URL: /api/users
  客户端: 10.0.1.100
  真实后端: 1.2.3.4:80
  风险等级: 🟢 LOW (0分)

  ✓ 自动放行
  耗时: 15ms
```

---

## 🔧 配置说明

### DNS 劫持器配置 (`dnshijack.go`)

```go
var config = Config{
    ListenAddr:    ":53",              // DNS 监听地址
    GatewayIP:     "10.0.0.1",         // Sentinel-AI 网关 IP
    UpstreamDNS:   "8.8.8.8:53",       // 上游 DNS
    HijackDomains: []string{          // 劫持域名列表
        "api.example.com",
        "db.example.com",
        "auth.example.com",
    },
    CacheTTL: 300,                     // DNS 缓存 TTL (秒)
}
```

### WAF 网关配置 (`wafgateway.go`)

```go
var config = Config{
    ListenAddr: "10.0.0.1:8080",       // WAF 监听地址
    DNSMapping: map[string]string{   // 域名 → 真实后端映射
        "api.example.com":  "1.2.3.4:80",
        "db.example.com":   "5.6.7.8:3306",
        "auth.example.com": "9.10.11.12:443",
    },
    OllamaURL:   "http://localhost:11434",
    OllamaModel: "qwen2.5:7b",
}
```

---

## 📊 完整架构

```
┌─────────────────────────────────────────────────────────────────┐
│                    Agent 容器 / 虚拟机                             │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │                   Agent 应用                             │  │
│  │                                                          │  │
│  │  requests.get('http://api.example.com/data')            │  │
│  │                                                         │  │
│  │  1. DNS 查询: api.example.com                           │  │
│  │  2. DNS 劫持器拦截                                       │  │
│  │  3. 返回假 IP: 10.0.0.1 (Sentinel-AI 网关)              │  │
│  │  4. Agent 连接到 10.0.0.1:8080                           │  │
│  └──────────────────────────────────────────────────────────┘  │
│                              │                                  │
└──────────────────────────────┼──────────────────────────────────┘
                               │
                               │ HTTP/gRPC/TCP
                               │ Host: api.example.com
                               │ IP: 10.0.0.1
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                   Sentinel-AI WAF 网关                             │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                   1. 连接接管                               │  │
│  │  - 接收连接                                               │  │
│  │  - 解析 Host 头: api.example.com                         │  │
│  │  - 从映射表获取真实 IP: 1.2.3.4:80                       │  │
│  └──────────────────────────────────────────────────────────┘  │
│                              │                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                   2. 风险评估                               │  │
│  │  - 方法检查 (GET/POST/DELETE...)                          │  │
│  │  - 路径检查 (/delete, /remove...)                          │  │
│  │  - 参数检查 (危险关键词)                                  │  │
│  │  - 环境检查 (prod/production)                            │  │
│  └──────────────────────────────────────────────────────────┘  │
│                              │                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                   3. 决策执行                               │  │
│  │  - 低风险 (< 30) → 自动放行                               │  │
│  │  - 中风险 (30-70) → 放行 + 警告                            │  │
│  │  - 高风险 (70-90) → 需要审批                               │  │
│  │  - 严重 (> 90) → 立即阻止                                  │  │
│  └──────────────────────────────────────────────────────────┘  │
│                              │                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                   4. 代理转发                             │  │
│  │  - 透明转发到真实后端 (1.2.3.4:80)                        │  │
│  │  - 注入安全头 (X-Sentinel-Protected)                      │  │
│  └──────────────────────────────────────────────────────────┘  │
└──────────────────────────────┼──────────────────────────────────┘
                               │
                               │ 代理到真实后端
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                  外部服务 (api.example.com)                       │
│                  真实 IP: 1.2.3.4:80                              │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🎯 优势

| 优势 | 说明 |
|------|------|
| **完全透明** | Agent 无需任何修改，无感知 |
| **无法绕过** | DNS 解析被劫持，Agent 不知道真实 IP |
| **全协议支持** | HTTP/HTTPS/gRPC/TCP 都可拦截 |
| **易于部署** | Sidecar 模式，不侵入原有架构 |
| **灵活策略** | 可以针对不同域名设置不同策略 |

---

## 🔒 安全加固

### 防绕过机制

1. **IP 访问检测**
   - 如果 Agent 直接用 IP 访问，立即告警

2. **DNS 劫持检测**
   - 检测 Agent 是否尝试使用其他 DNS 服务器

3. **eBPF 网络监控**
   - 监控所有系统调用，防止绕过 DNS 层

4. **流量指纹**
   - 如果流量模式异常，标记为可疑

5. **多层验证**
   - DNS 层 + 应用层 + 内核层，三层防御

---

## 📝 下一步

### 短期
- [ ] 集成 LLM 意图分析
- [ ] 添加企业微信/钉钉审批
- [ ] 实现 DNS 缓存优化
- [ ] 添加 TLS 终端

### 中期
- [ ] 支持 gRPC 协议
- [ ] 实现动态域名注册
- [ ] 添加流量指纹分析
- [ ] 实现自动学习策略

### 长期
- [ ] 集成 eBPF 监控
- [ ] 实现全链路追踪
- [ ] 添加 AI 自适应策略
- [ ] 支持多云部署

---

## 📞 技术支持

如有问题，请查看:
- `ARCHITECTURE_DNS_HIJACK.md` - 架构设计
- `dnshijack.go` - DNS 劫持器实现
- `wafgateway.go` - WAF 网关实现

---

**交付时间:** 2026-02-05
**版本:** v1.0
