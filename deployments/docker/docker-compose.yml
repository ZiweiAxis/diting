version: '3.8'

services:
  # Sentinel-AI Python 版本 (MVP 快速部署)
  sentinel-python:
    build:
      context: .
      target: python-base
      args:
        VERSION: "1.0.0"
        BUILD_DATE: "2026-02-05"
    image: sentinel-ai:python
    container_name: sentinel-python
    ports:
      - "8080:8080"
    environment:
      - SENTINEL_MODE=python
      - OLLAMA_ENDPOINT=http://host.docker.internal:11434
    volumes:
      - ./logs:/app/logs
      - ./config:/app/config:ro
    networks:
      - sentinel-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    profiles:
      - python

  # Sentinel-AI Go 高性能版本
  sentinel-go:
    build:
      context: .
      target: alpine
      args:
        VERSION: "1.0.0"
        BUILD_DATE: "2026-02-05"
    image: sentinel-ai:go
    container_name: sentinel-go
    ports:
      - "8080:8080"
    environment:
      - SENTINEL_MODE=go
      - OLLAMA_ENDPOINT=http://host.docker.internal:11434
    volumes:
      - ./logs:/app/logs
    networks:
      - sentinel-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    profiles:
      - go

  # Sentinel-AI eBPF 版本 (需要特权模式)
  sentinel-ebpf:
    build:
      context: .
      target: ebpf-base
      args:
        VERSION: "1.0.0"
        BUILD_DATE: "2026-02-05"
    image: sentinel-ai:ebpf
    container_name: sentinel-ebpf
    pid: host  # 共享主机的 PID 命名空间
    network_mode: host  # 共享主机网络
    privileged: true  # 特权模式
    cap_add:
      - SYS_ADMIN
      - SYS_PTRACE
      - NET_ADMIN
    volumes:
      - /sys/kernel/debug:/sys/kernel/debug:ro
      - /proc:/proc:ro
      - /usr/src:/usr/src:ro
      - /lib/modules:/lib/modules:ro
      - ./logs:/app/logs
    environment:
      - SENTINEL_MODE=ebpf
    restart: unless-stopped
    profiles:
      - ebpf

  # Web 管理界面 (未来功能)
  sentinel-web:
    image: nginx:alpine
    container_name: sentinel-web
    ports:
      - "8081:80"
    volumes:
      - ./web:/usr/share/nginx/html:ro
    networks:
      - sentinel-net
    depends_on:
      - sentinel-python
    restart: unless-stopped
    profiles:
      - web

  # Ollama (本地 LLM 服务)
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama-data:/root/.ollama
    environment:
      - OLLAMA_ORIGINS=*
    networks:
      - sentinel-net
    restart: unless-stopped
    profiles:
      - ollama

  # PostgreSQL (审计数据库)
  postgres:
    image: postgres:15-alpine
    container_name: sentinel-postgres
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=sentinel
      - POSTGRES_USER=sentinel
      - POSTGRES_PASSWORD=sentinel123
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - sentinel-net
    restart: unless-stopped
    profiles:
      - postgres

  # Redis (缓存和会话)
  redis:
    image: redis:7-alpine
    container_name: sentinel-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - sentinel-net
    restart: unless-stopped
    profiles:
      - redis

networks:
  sentinel-net:
    driver: bridge

volumes:
  ollama-data:
  postgres-data:
  redis-data:
