# Diting 部署架构说明

## 两种部署模式

### 模式 1：透明代理模式（推荐生产环境）

**使用 DNS 劫持 + Go 反向代理**

```
┌─────────────────────────────────────────────────────────┐
│                   AI Agent 容器                          │
│                                                          │
│  requests.get('https://api.openai.com/chat')        │
└────────────────┬─────────────────────────────────────────┘
                 │
                 │ DNS 查询: api.openai.com
                 ▼
┌─────────────────────────────────────────────────────────┐
│              CoreDNS (DNS 劫持)                          │
│                                                          │
│  api.openai.com → 10.0.0.1 (Diting IP)              │
│  api.github.com → 10.0.0.1                           │
│  *.example.com  → 10.0.0.1                           │
└────────────────┬─────────────────────────────────────────┘
                 │
                 │ HTTP 请求到 10.0.0.1:8080
                 ▼
┌─────────────────────────────────────────────────────────┐
│         Diting Go 反向代理 (10.0.0.1:8080)               │
│                                                          │
│  1. 接收请求                                             │
│  2. 从 Host 头获取真实目标                               │
│  3. 风险评估 + AI 分析                                   │
│  4. 人工审批（高风险）                                   │
│  5. 转发到真实 API                                       │
└────────────────┬─────────────────────────────────────────┘
                 │
                 │ 转发到真实 IP
                 ▼
┌─────────────────────────────────────────────────────────┐
│              真实外部 API                                │
│                                                          │
│  api.openai.com (真实 IP: 104.18.x.x)               │
│  api.github.com (真实 IP: 140.82.x.x)               │
└─────────────────────────────────────────────────────────┘
```

**优点**：
- ✅ 完全透明，Agent 无感知
- ✅ 无需修改 Agent 代码
- ✅ 无需配置代理环境变量
- ✅ 拦截所有网络流量

**部署**：
```bash
# 1. 启动 CoreDNS
docker run -d --name coredns \
  -v ./deployments/coredns:/etc/coredns \
  -p 53:53/udp \
  coredns/coredns

# 2. 启动 Diting
cd cmd/diting
go run main.go

# 3. 配置 Agent 容器使用 CoreDNS
docker run --dns=10.0.0.1 your-agent-image
```

---

### 模式 2：显式代理模式（快速测试）

**直接配置 HTTP_PROXY**

```
┌─────────────────────────────────────────────────────────┐
│                   AI Agent                               │
│                                                          │
│  export HTTP_PROXY=http://10.0.0.1:8080             │
│  requests.get('https://api.openai.com/chat')        │
└────────────────┬─────────────────────────────────────────┘
                 │
                 │ 直接发送到代理
                 ▼
┌─────────────────────────────────────────────────────────┐
│         Diting Go 反向代理 (10.0.0.1:8080)               │
│                                                          │
│  1. 接收代理请求                                         │
│  2. 风险评估 + AI 分析                                   │
│  3. 转发到真实 API                                       │
└────────────────┬─────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────┐
│              真实外部 API                                │
└─────────────────────────────────────────────────────────┘
```

**优点**：
- ✅ 部署简单
- ✅ 快速测试
- ✅ 不需要 DNS 服务器

**缺点**：
- ⚠️ 需要修改 Agent 环境变量
- ⚠️ Agent 可以绕过（删除环境变量）

**部署**：
```bash
# 1. 启动 Diting
cd cmd/diting
go run main.go

# 2. 配置 Agent
export HTTP_PROXY=http://localhost:8080
export HTTPS_PROXY=http://localhost:8080
python your_agent.py
```

---

## 推荐方案

### 开发/测试环境
使用 **模式 2（显式代理）**
- 快速上手
- 易于调试

### 生产环境
使用 **模式 1（DNS 劫持）**
- 完全透明
- 无法绕过
- 真正的零信任

---

## 为什么保留 DNS 劫持？

1. **零信任架构的核心**
   - Agent 无法绕过治理
   - 即使 Agent 代码被篡改也无效

2. **完全透明**
   - Agent 无需任何修改
   - 无需配置代理

3. **企业级部署**
   - 符合零信任安全模型
   - 满足合规要求

4. **与 Go 反向代理配合**
   - DNS 劫持：流量拦截
   - Go 代理：智能治理
   - 两者缺一不可

---

## 当前项目状态

✅ **Go 反向代理** - 已实现（cmd/diting/main.go）
✅ **DNS 劫持配置** - 已恢复（deployments/coredns/Corefile）
✅ **两种部署模式** - 都支持

---

## 下一步

需要我：
1. 更新 README 说明两种部署模式？
2. 创建 Docker Compose 配置（包含 CoreDNS + Diting）？
3. 添加部署脚本？
