# Diting 完整企业级架构

## 🏗️ 五层架构设计

```
┌─────────────────────────────────────────────────────────────────┐
│                    第一层：数据面 - 流量拦截                      │
│                                                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │
│  │  DNS 劫持     │  │  反向代理     │  │  eBPF 监控   │        │
│  │  (CoreDNS)   │  │  (Go Proxy)  │  │  (内核层)     │        │
│  └──────────────┘  └──────────────┘  └──────────────┘        │
└────────────────────────┬─────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    第二层：分析面 - 风险评估                      │
│                                                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │
│  │  规则引擎     │  │  LLM 分析    │  │  威胁情报     │        │
│  │  (方法/路径)  │  │  (意图识别)  │  │  (IP/域名)    │        │
│  └──────────────┘  └──────────────┘  └──────────────┘        │
│                                                                  │
│  ┌──────────────────────────────────────────────────────┐      │
│  │              风险评分计算                             │      │
│  │  - 规则引擎分数: 0-100                                │      │
│  │  - LLM 分析分数: 0-100                                │      │
│  │  - 威胁情报分数: 0-100                                │      │
│  │  - 历史行为分数: 0-100                                │      │
│  │  总分 = 加权平均                                       │      │
│  └──────────────────────────────────────────────────────┘      │
└────────────────────────┬─────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    第三层：策略面 - 决策引擎                      │
│                                                                  │
│  ┌──────────────────────────────────────────────────────┐      │
│  │                  策略引擎                             │      │
│  │                                                       │      │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐    │      │
│  │  │ 权限策略    │  │ 风控策略    │  │ 授权策略    │    │      │
│  │  │            │  │            │  │            │    │      │
│  │  │ - RBAC     │  │ - 频率限制  │  │ - OAuth2   │    │      │
│  │  │ - ABAC     │  │ - 金额限制  │  │ - JWT      │    │      │
│  │  │ - 资源权限  │  │ - 地域限制  │  │ - SAML     │    │      │
│  │  │ - 操作权限  │  │ - 时间窗口  │  │ - LDAP     │    │      │
│  │  └────────────┘  └────────────┘  └────────────┘    │      │
│  │                                                       │      │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐    │      │
│  │  │ 合规策略    │  │ 审计策略    │  │ 告警策略    │    │      │
│  │  │            │  │            │  │            │    │      │
│  │  │ - 等保2.0  │  │ - 全量日志  │  │ - 实时告警  │    │      │
│  │  │ - ISO27001 │  │ - 证据链    │  │ - 邮件通知  │    │      │
│  │  │ - SOC2     │  │ - 不可篡改  │  │ - 钉钉/企微 │    │      │
│  │  │ - GDPR     │  │ - 长期存储  │  │ - Webhook  │    │      │
│  │  └────────────┘  └────────────┘  └────────────┘    │      │
│  └──────────────────────────────────────────────────────┘      │
│                                                                  │
│  ┌──────────────────────────────────────────────────────┐      │
│  │              决策矩阵                                 │      │
│  │                                                       │      │
│  │  风险分数 × 权限策略 × 风控策略 → 决策               │      │
│  │                                                       │      │
│  │  - 低风险 + 有权限 + 通过风控 → 自动放行             │      │
│  │  - 中风险 + 有权限 + 通过风控 → 放行 + 警告          │      │
│  │  - 高风险 + 有权限 + 通过风控 → 人工审批             │      │
│  │  - 任意 + 无权限 → 立即拒绝                          │      │
│  │  - 任意 + 风控拦截 → 立即拒绝                        │      │
│  │  - 严重风险 → 立即阻止 + 告警                        │      │
│  └──────────────────────────────────────────────────────┘      │
└────────────────────────┬─────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    第四层：执行面 - 人机协同                      │
│                                                                  │
│  ┌──────────────────────────────────────────────────────┐      │
│  │              自动执行 (低/中风险)                      │      │
│  │                                                       │      │
│  │  - 立即放行/拒绝                                       │      │
│  │  - 记录审计日志                                        │      │
│  │  - 延迟 < 5ms                                          │      │
│  └──────────────────────────────────────────────────────┘      │
│                                                                  │
│  ┌──────────────────────────────────────────────────────┐      │
│  │              人工审批 (高风险)                         │      │
│  │                                                       │      │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐    │      │
│  │  │ CLI 审批    │  │ Web 审批   │  │ 移动审批    │    │      │
│  │  │            │  │            │  │            │    │      │
│  │  │ - 命令行    │  │ - 管理后台  │  │ - 企业微信  │    │      │
│  │  │ - 交互式    │  │ - 审批流程  │  │ - 钉钉      │    │      │
│  │  │ - 实时      │  │ - 多级审批  │  │ - Slack     │    │      │
│  │  └────────────┘  └────────────┘  └────────────┘    │      │
│  │                                                       │      │
│  │  审批信息:                                             │      │
│  │  - 请求详情 (方法/路径/参数)                          │      │
│  │  - 风险分析 (LLM 意图识别)                            │      │
│  │  - 历史行为 (该 Agent 过往记录)                       │      │
│  │  - 影响评估 (可能造成的后果)                          │      │
│  │  - 建议决策 (AI 推荐)                                 │      │
│  └──────────────────────────────────────────────────────┘      │
└────────────────────────┬─────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    第五层：存储面 - 审计追溯                      │
│                                                                  │
│  ┌──────────────────────────────────────────────────────┐      │
│  │              实时日志 (JSONL)                         │      │
│  │                                                       │      │
│  │  - 请求/响应完整记录                                   │      │
│  │  - 风险评分详情                                        │      │
│  │  - 决策过程记录                                        │      │
│  │  - 审批人信息                                          │      │
│  │  - 时间戳 (毫秒级)                                     │      │
│  └──────────────────────────────────────────────────────┘      │
│                                                                  │
│  ┌──────────────────────────────────────────────────────┐      │
│  │              长期存储 (数据库)                         │      │
│  │                                                       │      │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐    │      │
│  │  │ PostgreSQL │  │ ClickHouse │  │ S3/OSS     │    │      │
│  │  │            │  │            │  │            │    │      │
│  │  │ - 结构化    │  │ - 时序分析  │  │ - 归档存储  │    │      │
│  │  │ - 关系查询  │  │ - 大数据量  │  │ - 冷数据    │    │      │
│  │  │ - 事务支持  │  │ - 实时统计  │  │ - 合规要求  │    │      │
│  │  └────────────┘  └────────────┘  └────────────┘    │      │
│  └──────────────────────────────────────────────────────┘      │
│                                                                  │
│  ┌──────────────────────────────────────────────────────┐      │
│  │              分析平台                                  │      │
│  │                                                       │      │
│  │  - 行为分析 (异常检测)                                 │      │
│  │  - 趋势分析 (风险趋势)                                 │      │
│  │  - 合规报告 (自动生成)                                 │      │
│  │  - 可视化大屏 (实时监控)                               │      │
│  └──────────────────────────────────────────────────────┘      │
└─────────────────────────────────────────────────────────────────┘
```

---

## 📦 完整组件清单

### 数据面组件
- ✅ **CoreDNS** - DNS 劫持
- ✅ **Go Reverse Proxy** - 动态反向代理
- 🔄 **eBPF Monitor** - 内核级监控（规划中）

### 分析面组件
- ✅ **规则引擎** - 方法/路径/参数检查
- ✅ **LLM 分析** - Ollama/OpenAI 意图识别
- 🔄 **威胁情报** - IP/域名黑名单（规划中）
- 🔄 **行为分析** - 历史行为评分（规划中）

### 策略面组件
- 🔄 **权限策略引擎** - RBAC/ABAC
- 🔄 **风控策略引擎** - 频率/金额/地域限制
- 🔄 **授权策略引擎** - OAuth2/JWT/SAML
- 🔄 **合规策略引擎** - 等保2.0/ISO27001/SOC2
- 🔄 **审计策略引擎** - 全量日志/证据链
- 🔄 **告警策略引擎** - 实时告警/通知

### 执行面组件
- ✅ **CLI 审批** - 命令行交互式审批
- 🔄 **Web 审批** - 管理后台审批流程
- 🔄 **移动审批** - 企业微信/钉钉集成

### 存储面组件
- ✅ **JSONL 日志** - 实时审计日志
- 🔄 **PostgreSQL** - 结构化存储
- 🔄 **ClickHouse** - 时序分析
- 🔄 **S3/OSS** - 归档存储
- 🔄 **分析平台** - 行为分析/趋势分析/合规报告

---

## 🎯 当前实现状态

### ✅ 已实现（MVP）
1. DNS 劫持（CoreDNS 配置）
2. Go 动态反向代理
3. 基础风险评估（规则引擎）
4. LLM 意图分析（Ollama/OpenAI）
5. CLI 人工审批
6. JSONL 审计日志

### 🔄 规划中（企业级）
1. **策略引擎**
   - 权限策略（RBAC/ABAC）
   - 风控策略（频率/金额限制）
   - 授权策略（OAuth2/JWT）
   - 合规策略（等保2.0/ISO27001）

2. **高级分析**
   - 威胁情报集成
   - 行为分析引擎
   - 异常检测

3. **企业集成**
   - Web 管理后台
   - 企业微信/钉钉审批
   - LDAP/AD 集成
   - SSO 单点登录

4. **数据平台**
   - PostgreSQL 存储
   - ClickHouse 分析
   - 可视化大屏
   - 合规报告生成

5. **高级监控**
   - eBPF 内核监控
   - 实时告警
   - 性能监控

---

## 📝 架构演进路线

### Phase 1: MVP（当前）
- 核心拦截能力
- 基础风险评估
- 简单审批流程

### Phase 2: 企业级（3个月）
- 完整策略引擎
- Web 管理后台
- 企业集成

### Phase 3: 平台化（6个月）
- 数据分析平台
- 可视化大屏
- 自动化运营

### Phase 4: 生态化（12个月）
- 开放 API
- 插件市场
- 社区生态

---

这才是完整的企业级架构！我之前确实简化过头了，抱歉！

需要我：
1. 恢复所有架构文档？
2. 创建策略引擎的设计文档？
3. 规划完整的开发路线图？
